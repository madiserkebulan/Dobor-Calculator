<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Калькулятор">
    <link rel="manifest" href="/manifest.json">
    <title>Калькулятор доборных элементов</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f1f5f9; padding-bottom: 120px; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { display: none; }
        input[type=number] { -moz-appearance: textfield; }
        .header { position: sticky; top: 0; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header h1 { font-size: 18px; font-weight: bold; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; white-space: nowrap; }
        @media (max-width: 640px) {
            .header h1 { font-size: 16px; }
        }
        .status-online { background: #10b981; color: white; }
        .status-offline { background: #ef4444; color: white; }
        .lang-switcher { display: flex; gap: 8px; }
        .lang-btn { padding: 8px 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; background: #e5e7eb; }
        .lang-btn.active { background: #3b82f6; color: white; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .price-section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .label { display: block; font-size: 12px; font-weight: bold; color: #64748b; margin-bottom: 8px; }
        input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; outline: none; }
        input:focus { border-color: #3b82f6; }
        .element-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .element-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .element-title { font-size: 16px; font-weight: bold; color: #3b82f6; }
        .delete-btn { width: 32px; height: 32px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 20px; cursor: pointer; }
        .sides-container { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 16px; }
        .side-input { width: 80px; }
        .side-input input { padding: 8px; }
        .btn { padding: 8px 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-add { background: #10b981; color: white; }
        .btn-remove { background: #ef4444; color: white; }
        .results { background: #f8fafc; padding: 16px; border-radius: 8px; display: flex; gap: 16px; }
        .result-item { flex: 1; }
        .result-label { font-size: 11px; font-weight: bold; color: #64748b; margin-bottom: 4px; }
        .result-value { font-size: 18px; font-weight: bold; }
        .add-element-btn { width: 56px; height: 56px; background: #3b82f6; color: white; border: none; border-radius: 50%; font-size: 28px; cursor: pointer; margin-top: 12px; }
        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 20px; box-shadow: 0 -4px 12px rgba(0,0,0,0.1); }
        .footer-content { max-width: 900px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .footer-left { display: flex; gap: 8px; }
        .btn-pdf { padding: 12px 24px; background: #8b5cf6; color: white; }
        .btn-reset { padding: 12px 24px; background: white; color: black; border: 2px solid black; }
        .total-section { text-align: right; }
        .total-label { font-size: 12px; color: #64748b; margin-bottom: 4px; }
        .total-value { font-size: 24px; font-weight: bold; }
        .input-group { margin-bottom: 16px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <span id="statusBadge" class="status-badge status-online">Online</span>
            <h1 id="headerTitle">Калькулятор доборных элементов</h1>
        </div>
        <div class="lang-switcher">
            <button class="lang-btn" onclick="setLang('kz', event)">KZ</button>
            <button class="lang-btn active" onclick="setLang('ru', event)">RU</button>
        </div>
    </div>

    <div class="container">
        <div class="price-section">
            <label class="label" id="priceLabel">Цена×На развёртку</label>
            <input type="number" id="priceInput" placeholder="0" oninput="calculateAll()" onwheel="this.blur()">
        </div>
        <div id="elementsContainer"></div>
        <button class="add-element-btn" onclick="addElement()">+</button>
    </div>

    <div class="footer">
        <div class="footer-content">
            <div class="footer-left">
                <button class="btn btn-pdf" onclick="exportPDF()" id="pdfBtn">Экспорт PDF</button>
                <button class="btn btn-reset" onclick="resetAll()" id="resetBtn">Сброс</button>
            </div>
            <div class="total-section">
                <div class="total-label" id="totalLabel">Итого</div>
                <div class="total-value" id="totalValue">0 ₸</div>
            </div>
        </div>
    </div>

    <script>
    var translations = {
        ru: { title: 'Калькулятор доборных элементов', priceLabel: 'Цена×На развёртку', element: 'Доборный элемент', quantity: 'Кол-во п.м.', sides: 'Стороны (мм)', sum: 'R=', lineTotal: 'Сумма', total: 'Итого', exportPdf: 'Экспорт PDF', reset: 'Сброс', tenge: '₸' },
        kz: { title: 'Қосымша элементтер калькуляторы', priceLabel: 'Бағасы×Жайылымға', element: 'Қосымша элемент', quantity: 'Саны ш.м.', sides: 'Қабырғалар (мм)', sum: 'R=', lineTotal: 'Бағасы', total: 'Барлығы', exportPdf: 'PDF экспорты', reset: 'Тазарту', tenge: '₸' }
    };

    var currentLang = 'ru';
    var elements = [];
    var nextId = 1;
    var isOnline = navigator.onLine;

    elements.push({id: 1, quantity: '', sides: ['', '']});
    nextId = 2;

    function updateOnlineStatus() {
        var badge = document.getElementById('statusBadge');
        if (isOnline) {
            badge.className = 'status-badge status-online';
            badge.textContent = 'Online';
        } else {
            badge.className = 'status-badge status-offline';
            badge.textContent = 'Offline';
        }
    }

    function setLang(lang, e) {
        currentLang = lang;
        var btns = document.querySelectorAll('.lang-btn');
        for (var i = 0; i < btns.length; i++) btns[i].classList.remove('active');
        e.target.classList.add('active');
        updateTexts();
        renderElements();
    }

    function updateTexts() {
        var t = translations[currentLang];
        document.getElementById('headerTitle').textContent = t.title;
        document.getElementById('priceLabel').textContent = t.priceLabel;
        document.getElementById('totalLabel').textContent = t.total;
        document.getElementById('pdfBtn').textContent = t.exportPdf;
        document.getElementById('resetBtn').textContent = t.reset;
    }

    function roundByTable(value) {
        return Math.ceil(value / 0.05) * 0.05;
    }

    function calculateElement(element) {
        var sumMm = 0;
        for (var i = 0; i < element.sides.length; i++) sumMm = sumMm + (parseFloat(element.sides[i]) || 0);
        var sumM = sumMm / 1000;
        var rounded = roundByTable(sumM);
        var price = parseFloat(document.getElementById('priceInput').value) || 0;
        var pricePerMeter = rounded * price;
        var total = pricePerMeter * (parseFloat(element.quantity) || 0);
        return {sumMm: sumMm, pricePerMeter: pricePerMeter, total: total};
    }

    function calculateAll() {
        var t = translations[currentLang];
        for (var i = 0; i < elements.length; i++) {
            var calc = calculateElement(elements[i]);
            var sumEl = document.getElementById('sum-' + elements[i].id);
            var totalEl = document.getElementById('total-' + elements[i].id);
            if (sumEl) sumEl.textContent = calc.sumMm.toFixed(0);
            if (totalEl) totalEl.textContent = calc.total.toFixed(0) + ' ' + t.tenge;
        }
        updateTotalSum();
    }

    function updateTotalSum() {
        var total = 0;
        for (var i = 0; i < elements.length; i++) total = total + calculateElement(elements[i]).total;
        document.getElementById('totalValue').textContent = total.toFixed(0) + ' ' + translations[currentLang].tenge;
    }

    function addElement() {
        elements.push({id: nextId, quantity: '', sides: ['', '']});
        nextId = nextId + 1;
        renderElements();
    }

    function deleteElement(id) {
        var newEls = [];
        for (var i = 0; i < elements.length; i++) {
            if (elements[i].id !== id) newEls.push(elements[i]);
        }
        elements = newEls;
        renderElements();
    }

    function updateQuantity(id, value) {
        for (var i = 0; i < elements.length; i++) {
            if (elements[i].id === id) {
                elements[i].quantity = value;
                break;
            }
        }
        calculateAll();
    }

    function updateSide(id, index, value) {
        for (var i = 0; i < elements.length; i++) {
            if (elements[i].id === id) {
                elements[i].sides[index] = value;
                break;
            }
        }
        calculateAll();
    }

    function addSide(id) {
        for (var i = 0; i < elements.length; i++) {
            if (elements[i].id === id) {
                elements[i].sides.push('');
                break;
            }
        }
        renderElements();
    }

    function removeSide(id) {
        for (var i = 0; i < elements.length; i++) {
            if (elements[i].id === id && elements[i].sides.length > 2) {
                elements[i].sides.pop();
                break;
            }
        }
        renderElements();
    }

    function handleKeyDown(e, elementId, sideIndex) {
        if (e.key !== 'Enter') return;
        e.preventDefault();
        var element = null;
        var elementIndex = -1;
        for (var i = 0; i < elements.length; i++) {
            if (elements[i].id === elementId) {
                element = elements[i];
                elementIndex = i;
                break;
            }
        }
        if (sideIndex < element.sides.length - 1) {
            var next = document.querySelector('[data-side="' + elementId + '-' + (sideIndex + 1) + '"]');
            if (next) next.focus();
        } else if (elementIndex < elements.length - 1) {
            var nextEl = elements[elementIndex + 1];
            var next = document.querySelector('[data-side="' + nextEl.id + '-0"]');
            if (next) next.focus();
        }
    }

    function resetAll() {
        document.getElementById('priceInput').value = '';
        elements = [];
        elements.push({id: 1, quantity: '', sides: ['', '']});
        nextId = 2;
        renderElements();
    }

    function exportPDF() {
        var t = translations[currentLang];
        
        var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
        html += '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
        html += '<title>Коммерческое предложение</title>';
        html += '<style>';
        html += 'body { font-family: Arial, sans-serif; padding: 40px; max-width: 900px; margin: 0 auto; }';
        html += '.back-btn { position: fixed; top: 10px; left: 10px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; z-index: 1000; }';
        html += '.back-btn:hover { background: #2563eb; }';
        html += 'h1 { text-align: center; margin-bottom: 30px; font-size: 24px; margin-top: 60px; }';
        html += 'p { margin-bottom: 20px; line-height: 1.6; text-align: justify; }';
        html += 'table { width: 100%; border-collapse: collapse; margin-top: 30px; }';
        html += 'th, td { border: 1px solid #000; padding: 10px; text-align: left; }';
        html += 'th { background: #3b82f6; color: white; font-weight: bold; text-align: center; }';
        html += 'td:first-child { text-align: center; }';
        html += 'td:nth-child(3), td:nth-child(4), td:nth-child(5) { text-align: right; }';
        html += 'tfoot td { font-weight: bold; background: #f0f0f0; }';
        html += '@media print { .back-btn { display: none; } body { padding: 20px; } h1 { margin-top: 0; } }';
        html += '</style></head><body>';
        
        html += '<button class="back-btn" onclick="window.history.back()">← ' + (currentLang === 'ru' ? 'Назад' : 'Артқа') + '</button>';
        html += '<h1>' + (currentLang === 'ru' ? 'КОММЕРЧЕСКОЕ ПРЕДЛОЖЕНИЕ' : 'КОММЕРЦИЯЛЫҚ ҰСЫНЫС') + '</h1>';
        
        var companyText = currentLang === 'ru' 
            ? 'Almaty-Iron Inc создаёт доборные элементы и металлоизделия на листогибочных станках для объектов, где важны точность, сроки и предсказуемый результат. Мы обеспечиваем высокий уровень исполнения, строгое соответствие проектной документации и промышленную дисциплину производства. С нами заказчики получают не просто поставщика, а технологического партнёра, отвечающего за результат.'
            : 'Almaty-Iron Inc жоғары дәлдік, нақты мерзімдер және тұрақты нәтиже талап етілетін нысандар үшін листогибтік станоктарда доборлық элементтер мен металл бұйымдарын өндіреді. Біз әр тапсырысты жобалық құжаттамаға толық сәйкестікпен және өндірістік тәртіпті сақтай отырып орындаймыз. Сондықтан тапсырыс берушілер бізді тек жеткізуші ретінде емес, нәтиже үшін жауапкершілік алатын сенімді технологиялық серіктес ретінде таңдайды.';
        
        html += '<p>' + companyText + '</p>';
        
        html += '<table><thead><tr>';
        html += '<th>№</th>';
        html += '<th>' + (currentLang === 'ru' ? 'Наименование' : 'Атауы') + '</th>';
        html += '<th>' + (currentLang === 'ru' ? 'Кол-во, м.п.' : 'Саны, ш.м.') + '</th>';
        html += '<th>' + (currentLang === 'ru' ? 'Цена за м.п.' : 'Бағасы ш.м.') + '</th>';
        html += '<th>' + (currentLang === 'ru' ? 'Сумма, тг.' : 'Сома, тг.') + '</th>';
        html += '</tr></thead><tbody>';
        
        var total = 0;
        for (var i = 0; i < elements.length; i++) {
            var calc = calculateElement(elements[i]);
            total = total + calc.total;
            html += '<tr>';
            html += '<td>' + (i + 1) + '</td>';
            html += '<td>' + t.element + ' ' + (i + 1) + '</td>';
            html += '<td>' + (parseFloat(elements[i].quantity) || 0).toFixed(2) + '</td>';
            html += '<td>' + calc.pricePerMeter.toFixed(2) + '</td>';
            html += '<td>' + calc.total.toFixed(2) + '</td>';
            html += '</tr>';
        }
        
        html += '</tbody><tfoot><tr>';
        html += '<td colspan="4" style="text-align: right;">' + (currentLang === 'ru' ? 'Итого:' : 'Барлығы:') + '</td>';
        html += '<td>' + total.toFixed(2) + '</td>';
        html += '</tr></tfoot></table>';
        html += '</body></html>';
        
        var blob = new Blob([html], {type: 'text/html'});
        var url = URL.createObjectURL(blob);
        window.location.href = url;
    }

    function renderElements() {
        var t = translations[currentLang];
        var html = '';
        for (var i = 0; i < elements.length; i++) {
            var el = elements[i];
            var calc = calculateElement(el);
            html = html + '<div class="element-card">';
            html = html + '<div class="element-header"><div class="element-title">' + t.element + ' ' + (i + 1) + '</div>';
            html = html + '<button class="delete-btn" onclick="deleteElement(' + el.id + ')">−</button></div>';
            html = html + '<div class="input-group"><label class="label">' + t.quantity + '</label>';
            html = html + '<input type="number" value="' + el.quantity + '" oninput="updateQuantity(' + el.id + ', this.value)" onwheel="this.blur()" placeholder="0"></div>';
            html = html + '<div class="input-group"><label class="label">' + t.sides + '</label><div class="sides-container">';
            for (var j = 0; j < el.sides.length; j++) {
                html = html + '<div class="side-input"><input type="number" value="' + el.sides[j] + '" data-side="' + el.id + '-' + j + '" oninput="updateSide(' + el.id + ', ' + j + ', this.value)" onwheel="this.blur()" onkeydown="handleKeyDown(event, ' + el.id + ', ' + j + ')" placeholder="0"></div>';
            }
            html = html + '<button class="btn btn-add" onclick="addSide(' + el.id + ')">+</button>';
            if (el.sides.length > 2) html = html + '<button class="btn btn-remove" onclick="removeSide(' + el.id + ')">−</button>';
            html = html + '</div></div>';
            html = html + '<div class="results"><div class="result-item"><div class="result-label">' + t.sum + '</div><div class="result-value" id="sum-' + el.id + '">' + calc.sumMm.toFixed(0) + '</div></div>';
            html = html + '<div class="result-item"><div class="result-label">' + t.lineTotal + '</div><div class="result-value" id="total-' + el.id + '">' + calc.total.toFixed(0) + ' ' + t.tenge + '</div></div></div></div>';
        }
        document.getElementById('elementsContainer').innerHTML = html;
        calculateAll();
    }

    window.addEventListener('online', function() { isOnline = true; updateOnlineStatus(); });
    window.addEventListener('offline', function() { isOnline = false; updateOnlineStatus(); });

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js').then(function(registration) {
                console.log('ServiceWorker registered');
                registration.addEventListener('updatefound', function() {
                    var newWorker = registration.installing;
                    newWorker.addEventListener('statechange', function() {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            if (confirm('Доступна новая версия! Обновить сейчас?')) {
                                window.location.reload();
                            }
                        }
                    });
                });
            }).catch(function(err) {
                console.log('ServiceWorker registration failed:', err);
            });
        });
    }

    renderElements();
    updateOnlineStatus();
    </script>
</body>
</html>
