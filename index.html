<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e293b">
    <title>Калькулятор доборных элементов</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogItCa0LDQu9GM0LrRg9C70Y/RgtC+0YAg0LTQvtCx0L7RgNC90YvRhSDRjdC70LXQvNC10L3RgtC+0LIiLAogICJzaG9ydF9uYW1lIjogItCa0LDQu9GM0LrRg9C70Y/RgtC+0YAiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2YxZjVmOSIsCiAgInRoZW1lX2NvbG9yIjogIiMxZTI5M2IiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDcmVjdCB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgZmlsbD0nJTIzM2I4MmY2Jy8lM0UlM0N0ZXh0IHg9JzUwJyB5PSc2MCcgZm9udC1zaXplPSc0MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nd2hpdGUnIGZvbnQtZmFtaWx5PSdBcmlhbCclM0XQlCVDMy90ZXh0JTNFJTNDL3N2ZyUzRSIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f1f5f9;
            padding: 20px;
            padding-bottom: 100px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: #1e293b;
            margin-bottom: 24px;
            font-size: 24px;
        }

        .price-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .price-label {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .price-input {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            outline: none;
        }

        .price-input:focus {
            border-color: #3b82f6;
        }

        .price-input::-webkit-inner-spin-button,
        .price-input::-webkit-outer-spin-button {
            display: none;
        }

        .row-container {
            position: relative;
            margin-bottom: 12px;
        }

        .row {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .row-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .row-number {
            color: #3b82f6;
            font-weight: bold;
            font-size: 16px;
        }

        .delete-row-btn {
            background: #ef4444;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .delete-row-btn:active {
            transform: scale(0.95);
        }

        .row-header {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .input-group {
            position: relative;
            flex: 1;
            min-width: 120px;
        }

        .input-label {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 4px;
            display: block;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            outline: none;
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"]:focus {
            border-color: #3b82f6;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            display: none;
        }

        .sides-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .side-input {
            position: relative;
            width: 80px;
        }

        .side-input.deleting .delete-x {
            display: none;
        }

        .delete-x {
            display: none;
        }

        .side-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-add {
            background: #10b981;
            color: white;
        }

        .btn-remove {
            background: #ef4444;
            color: white;
        }

        .result-box {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .result-item {
            flex: 1;
            min-width: 120px;
        }

        .result-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
        }

        .result-value {
            font-size: 18px;
            font-weight: bold;
            color: #1e293b;
        }

        .add-row-btn {
            background: #3b82f6;
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .total-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
        }

        .total-content {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .btn-total {
            background: #3b82f6;
            color: white;
            padding: 16px 32px;
            font-size: 18px;
        }

        .total-value {
            flex: 1;
            font-size: 24px;
            font-weight: bold;
            color: #1e293b;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Калькулятор доборных элементов</h1>
        
        <div class="price-section">
            <div class="price-label">Цена*На развёртку</div>
            <input type="number" class="price-input" id="pricePerSqm" value="" oninput="calculateAll()" onwheel="this.blur()">
        </div>

        <div id="rows"></div>
    </div>

    <div class="total-section">
        <div class="total-content">
            <button class="btn btn-total" onclick="calculateTotal()">Итого</button>
            <div class="total-value" id="totalValue">0 тг</div>
        </div>
    </div>

    <script>
        let rows = [];
        let rowIdCounter = 1;

        function roundByTable(value) {
            const ranges = [
                [0.05, 0.10, 0.10],
                [0.10, 0.15, 0.15],
                [0.15, 0.20, 0.20],
                [0.20, 0.25, 0.25],
                [0.25, 0.30, 0.30],
                [0.30, 0.35, 0.35],
                [0.35, 0.40, 0.40],
                [0.40, 0.45, 0.45],
                [0.45, 0.50, 0.50],
                [0.50, 0.55, 0.55],
                [0.55, 0.60, 0.60],
                [0.60, 0.65, 0.65],
                [0.65, 0.70, 0.70],
                [0.70, 0.75, 0.75],
                [0.75, 0.80, 0.80],
                [0.80, 0.85, 0.85],
                [0.85, 0.90, 0.90],
                [0.90, 0.95, 0.95],
                [0.95, 1.00, 1.00],
                [1.00, 1.05, 1.05],
                [1.05, 1.10, 1.10],
                [1.10, 1.15, 1.15],
                [1.15, 1.20, 1.20],
                [1.20, 1.25, 1.25]
            ];

            for (let [min, max, result] of ranges) {
                if (value > min && value <= max) {
                    return result;
                }
            }

            const step = 0.05;
            return Math.ceil(value / step) * step;
        }

        function createRow() {
            const id = rowIdCounter++;
            const row = {
                id,
                quantity: '',
                sides: ['', '']
            };
            rows.push(row);
            renderRows();
        }

        function deleteRow(id) {
            rows = rows.filter(r => r.id !== id);
            renderRows();
        }

        function addSide(rowId) {
            const row = rows.find(r => r.id === rowId);
            if (row) {
                row.sides.push('');
                renderRows();
            }
        }

        function removeSide(rowId) {
            const row = rows.find(r => r.id === rowId);
            if (row && row.sides.length > 2) {
                row.sides.pop();
                renderRows();
            }
        }

        function deleteSide(rowId, sideIndex) {
            const row = rows.find(r => r.id === rowId);
            if (row && row.sides.length > 2) {
                row.sides.splice(sideIndex, 1);
                renderRows();
            }
        }

        function updateQuantity(rowId, value) {
            const row = rows.find(r => r.id === rowId);
            if (row) {
                row.quantity = parseFloat(value) || 0;
                calculateAll();
            }
        }

        function updateSide(rowId, sideIndex, value) {
            const row = rows.find(r => r.id === rowId);
            if (row) {
                row.sides[sideIndex] = parseFloat(value) || 0;
                calculateAll();
            }
        }

        function handleEnterKey(e, rowId, sideIndex) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const row = rows.find(r => r.id === rowId);
                if (!row) return;

                const nextSideIndex = sideIndex + 1;
                if (nextSideIndex < row.sides.length) {
                    const nextInput = document.querySelector(`[data-side="${rowId}-${nextSideIndex}"]`);
                    if (nextInput) nextInput.focus();
                } else {
                    const rowIndex = rows.findIndex(r => r.id === rowId);
                    if (rowIndex < rows.length - 1) {
                        const nextRow = rows[rowIndex + 1];
                        const firstInput = document.querySelector(`[data-side="${nextRow.id}-0"]`);
                        if (firstInput) firstInput.focus();
                    }
                }
            }
        }

        function calculateRow(row) {
            const sumMm = row.sides.reduce((a, b) => a + b, 0);
            const sumM = sumMm / 1000;
            const rounded = roundByTable(sumM);
            const pricePerSqm = parseFloat(document.getElementById('pricePerSqm').value) || 0;
            const pricePerM = rounded * pricePerSqm;
            const total = pricePerM * row.quantity;

            return {
                sumMm,
                rounded,
                total
            };
        }

        function calculateAll() {
            rows.forEach(row => {
                const calc = calculateRow(row);
                const el = document.querySelector(`[data-row-id="${row.id}"]`);
                if (el) {
                    el.querySelector('.r-value').textContent = `${calc.sumMm}`;
                    el.querySelector('.total-value').textContent = `${Math.round(calc.total)} тг`;
                }
            });
        }

        function calculateTotal() {
            const total = rows.reduce((sum, row) => {
                const calc = calculateRow(row);
                return sum + calc.total;
            }, 0);
            document.getElementById('totalValue').textContent = `${Math.round(total)} тг`;
        }

        let touchStartX = 0;
        let touchStartY = 0;
        let currentSwipedRow = null;

        function handleTouchStart(e, rowId) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }

        function handleTouchMove(e, rowId) {
            if (!touchStartX) return;

            const touchEndX = e.touches[0].clientX;
            const touchEndY = e.touches[0].clientY;
            const diffX = touchStartX - touchEndX;
            const diffY = Math.abs(touchStartY - touchEndY);

            if (diffY > 50) return;

            if (diffX > 50) {
                const rowEl = document.querySelector(`[data-row-id="${rowId}"]`);
                if (currentSwipedRow && currentSwipedRow !== rowEl) {
                    currentSwipedRow.classList.remove('swiped');
                }
                rowEl.classList.add('swiped');
                currentSwipedRow = rowEl;
            }
        }

        function handleTouchEnd() {
            touchStartX = 0;
            touchStartY = 0;
        }

        let longPressTimer = null;
        let longPressTarget = null;

        function handleLongPressStart(e, rowId, sideIndex) {
            if (e.target.tagName === 'INPUT') return;
            e.preventDefault();
            longPressTarget = e.currentTarget;
            longPressTimer = setTimeout(() => {
                longPressTarget.classList.add('deleting');
            }, 800);
        }

        function handleLongPressEnd(e) {
            if (e && e.target.tagName === 'INPUT') return;
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        function renderRows() {
            const container = document.getElementById('rows');
            container.innerHTML = rows.map((row, index) => `
                <div class="row-container">
                    <div class="row" data-row-id="${row.id}">
                        <div class="row-header-top">
                            <div class="row-number">Доборный элемент ${index + 1}</div>
                            <button class="delete-row-btn" onclick="deleteRow(${row.id})">−</button>
                        </div>
                        
                        <div class="row-header">
                            <div class="input-group">
                                <label class="input-label">Кол-во п.м.</label>
                                <input type="number" value="${row.quantity}" 
                                       oninput="updateQuantity(${row.id}, this.value)"
                                       onwheel="this.blur()">
                            </div>
                        </div>

                        <div class="sides-container">
                            ${row.sides.map((side, i) => `
                                <div class="side-input">
                                    <input type="number" value="${side}" 
                                           data-side="${row.id}-${i}"
                                           oninput="updateSide(${row.id}, ${i}, this.value)"
                                           onkeydown="handleEnterKey(event, ${row.id}, ${i})"
                                           onwheel="this.blur()">
                                </div>
                            `).join('')}
                            <div class="side-controls">
                                <button class="btn btn-add" onclick="addSide(${row.id})">+</button>
                                ${row.sides.length > 2 ? `<button class="btn btn-remove" onclick="removeSide(${row.id})">-</button>` : ''}
                            </div>
                        </div>

                        <div class="result-box">
                            <div class="result-item">
                                <div class="result-label">R=</div>
                                <div class="result-value r-value">0</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Стоимость</div>
                                <div class="result-value total-value">0 тг</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('') + '<button class="btn add-row-btn" onclick="createRow()">+</button>';
            
            calculateAll();
        }

        createRow();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript,');
        }
    </script>
</body>
</html>